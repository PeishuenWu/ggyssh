<!DOCTYPE html>
<html>
<head>
    <title>GgySSH Bridge</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Xterm -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" />
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>
    <style>
        body { background: #121212; color: #e0e0e0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* Top Navigation/Login */
        #login-form { padding: 1rem; background: #1e1e1e; border-bottom: 1px solid #333; }
        
        /* Main Layout */
        #main-container { flex: 1; display: flex; overflow: hidden; position: relative; background: #000; }
        #terminal-container { flex: 3; padding: 0; overflow: hidden; min-width: 200px; }
        
        /* Resizer */
        #resizer {
            width: 4px;
            cursor: col-resize;
            background: #333;
            transition: background 0.2s;
            z-index: 10;
        }
        #resizer:hover, #resizer.dragging {
            background: #0d6efd;
        }
        
        /* File Explorer */
        #file-explorer { flex: 1; background: #1e1e1e; border-left: 1px solid #333; display: flex; flex-direction: column; overflow: hidden; min-width: 150px; }
        #explorer-header { padding: 0.5rem 0.75rem; background: #252525; border-bottom: 1px solid #333; }
        #current-path { font-size: 0.75rem; color: #aaa; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-top: 4px; }
        #explorer-list { flex: 1; overflow-y: auto; }
        
        /* List View Items */
        #explorer-list.list-view .file-item { 
            padding: 0.4rem 0.75rem; display: flex; align-items: center; gap: 0.5rem; 
            cursor: pointer; border-bottom: 1px solid #2a2a2a; font-size: 0.875rem;
            transition: background 0.1s;
        }
        #explorer-list.list-view .file-item:hover { background: #2a2a2a; }
        #explorer-list.list-view .file-item .icon { font-size: 1rem; width: 1.25rem; text-align: center; }
        #explorer-list.list-view .file-item .name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        #explorer-list.list-view .file-item .size { color: #888; font-size: 0.75rem; }
        #explorer-list.list-view .file-item .actions { visibility: hidden; display: flex; gap: 5px; }
        #explorer-list.list-view .file-item:hover .actions { visibility: visible; }
        .item-checkbox { cursor: pointer; }

        /* Grid View Items */
        #explorer-list.grid-view { display: flex; flex-wrap: wrap; gap: 0.5rem; padding: 0.75rem; align-content: flex-start; }
        #explorer-list.grid-view .file-item { 
            width: 90px; height: 100px; display: flex; flex-direction: column; align-items: center; justify-content: center; 
            padding: 0.5rem; cursor: pointer; border-radius: 0.375rem; position: relative;
            transition: background 0.1s;
        }
        #explorer-list.grid-view .file-item:hover { background: #2a2a2a; }
        #explorer-list.grid-view .file-item .item-checkbox { position: absolute; top: 5px; left: 5px; z-index: 5; }
        #explorer-list.grid-view .file-item .actions { position: absolute; top: 5px; right: 5px; visibility: hidden; z-index: 5; }
        #explorer-list.grid-view .file-item:hover .actions { visibility: visible; }
        #explorer-list.grid-view .file-item .icon { font-size: 2rem; margin-bottom: 0.25rem; }
        #explorer-list.grid-view .file-item .name { 
            font-size: 0.75rem; width: 100%; overflow: hidden; text-overflow: ellipsis; 
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; 
            line-height: 1.2; height: 2.4em; text-align: center;
        }
        #explorer-list.grid-view .file-item .actions { position: absolute; top: 2px; right: 2px; visibility: hidden; }
        #explorer-list.grid-view .file-item:hover .actions { visibility: visible; }

        /* Upload Area */
        #upload-area { padding: 0.75rem 1rem; background: #1e1e1e; border-top: 1px solid #333; }
        #drop-zone {
            border: 2px dashed #444;
            border-radius: 0.375rem;
            padding: 0.5rem 1rem;
            color: #aaa;
            font-size: 0.875rem;
            text-align: center;
            transition: all 0.2s;
            cursor: pointer;
        }
        #drop-zone.drag-over {
            border-color: #0d6efd;
            background: rgba(13, 110, 253, 0.1);
            color: #fff;
        }
        
        .xterm-viewport { background-color: #000 !important; }
        .hidden { display: none !important; }
        
        /* Bootstrap Overrides for Dark Theme */
        .form-control, .form-select { background-color: #2a2a2a; border-color: #444; color: #eee; }
        .form-control:focus, .form-select:focus { background-color: #333; border-color: #0d6efd; color: #fff; box-shadow: none; }
        .btn-outline-secondary { color: #aaa; border-color: #444; }
        .btn-outline-secondary:hover { background-color: #333; border-color: #555; color: #fff; }
    </style>
</head>
<body>
    <div id="login-form">
        <div class="container-fluid">
            <div class="row g-2 align-items-end">
                <div class="col-md-3">
                    <label class="form-label small text-secondary">SSH Host</label>
                    <div class="input-group input-group-sm">
                        <input id="host" class="form-control" placeholder="Host" value="localhost" />
                        <input id="port" class="form-control" style="max-width: 70px;" placeholder="Port" value="22" type="number" />
                    </div>
                </div>
                <div class="col-md-2">
                    <label class="form-label small text-secondary">Username</label>
                    <input id="user" class="form-control form-control-sm" placeholder="Username" />
                </div>
                <div class="col-md-2">
                    <label class="form-label small text-secondary">Auth Type</label>
                    <select id="auth_type" class="form-select form-select-sm" onchange="toggleAuth()">
                        <option value="password">Password</option>
                        <option value="key">Private Key</option>
                    </select>
                </div>
                <div id="password-input" class="col-md-3">
                    <label class="form-label small text-secondary">Password</label>
                    <input id="pass" class="form-control form-control-sm" placeholder="Password" type="password" />
                </div>
                <div id="key-input" class="col-md-3 hidden">
                    <label class="form-label small text-secondary">Private Key</label>
                    <textarea id="key" class="form-control form-control-sm" style="height: 31px;" placeholder="Paste Private Key..."></textarea>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-primary btn-sm w-100" onclick="connect()">
                        <i class="bi bi-plug-fill"></i> Connect
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="main-container">
        <div id="terminal-container"></div>
        <div id="resizer" class="hidden"></div>
        <div id="file-explorer" class="hidden">
            <div id="explorer-header">
                <div class="d-flex justify-content-between align-items-center">
                    <span class="fw-bold small">Explorer</span>
                    <div class="btn-group btn-group-sm">
                        <button onclick="deleteSelected()" class="btn btn-outline-danger py-0 px-2 hidden" id="btn-delete-selected" title="Delete Selected">
                            <i class="bi bi-trash-fill"></i>
                        </button>
                        <button onclick="toggleHiddenFiles()" class="btn btn-outline-secondary py-0 px-2" id="btn-toggle-hidden" title="Toggle Hidden Files">
                            <i class="bi bi-eye-slash"></i>
                        </button>
                        <button onclick="setViewMode('list')" class="btn btn-outline-secondary py-0 px-2" id="btn-list-view" title="List View">
                            <i class="bi bi-list"></i>
                        </button>
                        <button onclick="setViewMode('grid')" class="btn btn-outline-secondary py-0 px-2" id="btn-grid-view" title="Grid View">
                            <i class="bi bi-grid-3x3-gap"></i>
                        </button>
                        <button onclick="refreshFiles()" class="btn btn-outline-secondary py-0 px-2" title="Refresh">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                    </div>
                </div>
                <div id="current-path" class="text-muted">/</div>
            </div>
            <div id="explorer-list" class="list-view"></div>
        </div>
    </div>

    <div id="upload-area" class="hidden">
        <div class="container-fluid">
            <div class="row g-2 align-items-center">
                <div class="col-md-3">
                    <div id="drop-zone">
                        <i class="bi bi-cloud-upload"></i> Drag or Click to Upload
                    </div>
                    <input type="file" id="fileInput" class="hidden" />
                </div>
                <div class="col-md-auto">
                    <span id="selectedFileName" class="badge bg-dark text-info"></span>
                </div>
                <div class="col-md">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text"><i class="bi bi-folder-symlink"></i></span>
                        <input type="text" id="remotePath" class="form-control" placeholder="Remote Path" />
                    </div>
                </div>
                <div class="col-md-auto">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="autoInputPath" checked>
                        <label class="form-check-label small" for="autoInputPath">Auto-Input</label>
                    </div>
                </div>
                <div class="col-md-auto">
                    <button class="btn btn-success btn-sm" onclick="uploadFile()">
                        <i class="bi bi-upload"></i> Upload
                    </button>
                </div>
                <div class="col text-end">
                    <span id="upload-status" class="small text-warning"></span>
                </div>
            </div>
        </div>
    </div>

    <script>
        function toggleAuth() {
            const type = document.getElementById('auth_type').value;
            document.getElementById('password-input').classList.toggle('hidden', type === 'key');
            document.getElementById('key-input').classList.toggle('hidden', type === 'password');
        }

        const term = new Terminal({ 
            theme: { background: '#1a1a1a' }, 
            cursorBlink: true,
            fontFamily: 'Menlo, Monaco, "Courier New", monospace',
            fontSize: 14
        });
        const fitAddon = new FitAddon.FitAddon();
        term.loadAddon(fitAddon);
        term.open(document.getElementById('terminal-container'));
        fitAddon.fit();

        let socket;
        let remotePathTouched = false;
        let droppedFile = null;
        let isUploading = false;
        const dropZoneDefaultText = 'Drag file here';
        const textEncoder = new TextEncoder();

        // Resizer logic
        const resizer = document.getElementById('resizer');
        const terminalContainer = document.getElementById('terminal-container');
        const fileExplorer = document.getElementById('file-explorer');
        let isResizing = false;

        resizer.addEventListener('mousedown', (e) => {
            isResizing = true;
            resizer.classList.add('dragging');
            document.body.style.cursor = 'col-resize';
            e.preventDefault();
        });

        document.addEventListener('mousemove', (e) => {
            if (!isResizing) return;
            const container = document.getElementById('main-container');
            const containerWidth = container.offsetWidth;
            const leftWidth = e.clientX;
            const rightWidth = containerWidth - leftWidth - resizer.offsetWidth;
            
            if (leftWidth > 200 && rightWidth > 150) {
                terminalContainer.style.flex = 'none';
                terminalContainer.style.width = `${leftWidth}px`;
                fileExplorer.style.flex = '1';
                fileExplorer.style.width = 'auto';
                
                fitAddon.fit();
                sendResize();
            }
        });

        document.addEventListener('mouseup', () => {
            if (isResizing) {
                isResizing = false;
                resizer.classList.remove('dragging');
                document.body.style.cursor = 'default';
                fitAddon.fit();
                sendResize();
            }
        });

        let currentExplorerPath = '';
        let viewMode = 'list'; // 'list' or 'grid'
        let showHidden = false;
        let cachedFiles = [];
        let selectedItems = new Set();

        function toggleHiddenFiles() {
            showHidden = !showHidden;
            const btn = document.getElementById('btn-toggle-hidden');
            btn.innerHTML = showHidden ? '<i class="bi bi-eye"></i>' : '<i class="bi bi-eye-slash"></i>';
            btn.classList.toggle('btn-primary', showHidden);
            btn.classList.toggle('btn-outline-secondary', !showHidden);
            
            selectedItems.clear();
            updateDeleteButton();
            if (cachedFiles.length > 0) {
                renderFileList(cachedFiles);
            }
        }

        function updateDeleteButton() {
            const btn = document.getElementById('btn-delete-selected');
            if (selectedItems.size > 0) {
                btn.classList.remove('hidden');
                btn.innerHTML = `<i class="bi bi-trash-fill"></i> (${selectedItems.size})`;
            } else {
                btn.classList.add('hidden');
            }
        }

        async function deleteSelected() {
            if (selectedItems.size === 0) return;
            if (!confirm(`Delete ${selectedItems.size} selected items?`)) return;

            const itemsToDelete = Array.from(selectedItems);
            let successCount = 0;
            let failCount = 0;

            for (const fullPath of itemsToDelete) {
                try {
                    const resp = await fetch('/sftp/action', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            ...getCreds(),
                            action: 'delete',
                            path: fullPath
                        })
                    });
                    if (resp.ok) successCount++;
                    else failCount++;
                } catch (e) {
                    failCount++;
                }
            }

            selectedItems.clear();
            updateDeleteButton();
            refreshFiles();
            if (failCount > 0) {
                alert(`Deletion finished: ${successCount} success, ${failCount} failed.`);
            }
        }

        function setViewMode(mode) {
            viewMode = mode;
            const listContainer = document.getElementById('explorer-list');
            listContainer.className = mode + '-view';
            
            // Highlight active button using Bootstrap classes
            const btnList = document.getElementById('btn-list-view');
            const btnGrid = document.getElementById('btn-grid-view');
            
            if (mode === 'list') {
                btnList.classList.replace('btn-outline-secondary', 'btn-primary');
                btnGrid.classList.replace('btn-primary', 'btn-outline-secondary');
            } else {
                btnGrid.classList.replace('btn-outline-secondary', 'btn-primary');
                btnList.classList.replace('btn-primary', 'btn-outline-secondary');
            }
            
            if (cachedFiles.length > 0) {
                renderFileList(cachedFiles);
            }
        }

        function getCreds() {
            return {
                host: document.getElementById('host').value,
                port: parseInt(document.getElementById('port').value),
                user: document.getElementById('user').value,
                auth_type: document.getElementById('auth_type').value,
                pass: document.getElementById('pass').value,
                key: document.getElementById('key').value
            };
        }

        async function refreshFiles() {
            const listContainer = document.getElementById('explorer-list');
            listContainer.innerHTML = '<div style="padding: 10px; color: #888;">Loading...</div>';
            
            selectedItems.clear();
            updateDeleteButton();

            try {
                const resp = await fetch('/sftp/list', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ...getCreds(),
                        path: currentExplorerPath || '.'
                    })
                });
                
                if (!resp.ok) throw new Error(await resp.text());
                
                cachedFiles = await resp.json();
                renderFileList(cachedFiles);
            } catch (e) {
                listContainer.innerHTML = `<div style="padding: 10px; color: #f44;">Error: ${e.message}</div>`;
            }
        }

        function renderFileList(files) {
            const listContainer = document.getElementById('explorer-list');
            listContainer.innerHTML = '';

            // Back button
            if (currentExplorerPath && currentExplorerPath !== '/' && currentExplorerPath !== '.') {
                const backItem = document.createElement('div');
                backItem.className = 'file-item';
                backItem.title = 'Go back';
                backItem.innerHTML = `<span class="icon text-primary"><i class="bi bi-arrow-90deg-up"></i></span> <span class="name text-primary">..</span>`;
                backItem.onclick = () => {
                    const parts = currentExplorerPath.split('/').filter(p => p);
                    parts.pop();
                    currentExplorerPath = '/' + parts.join('/');
                    if (currentExplorerPath === '/') currentExplorerPath = '';
                    document.getElementById('current-path').innerText = currentExplorerPath || '/';
                    refreshFiles();
                };
                listContainer.appendChild(backItem);
            }

            // Sort: directories first
            files.sort((a, b) => {
                if (a.is_dir !== b.is_dir) return b.is_dir ? 1 : -1;
                return a.name.localeCompare(b.name);
            });

            files.forEach(file => {
                if (!showHidden && file.name.startsWith('.')) {
                    return;
                }
                const fullPath = (currentExplorerPath === '' ? '' : currentExplorerPath + '/') + file.name;
                const isSelected = selectedItems.has(fullPath);

                const item = document.createElement('div');
                item.className = 'file-item';
                if (isSelected) item.classList.add('bg-primary-subtle');
                
                const iconClass = file.is_dir ? 'bi bi-folder-fill text-warning' : 'bi bi-file-earmark-text text-secondary';
                const size = file.is_dir ? '' : formatBytes(file.size);
                
                const checkboxHtml = `<input type="checkbox" class="form-check-input item-checkbox" ${isSelected ? 'checked' : ''} onclick="event.stopPropagation(); toggleItemSelection('${fullPath}')">`;
                const actionsHtml = `
                    <div class="actions">
                        <button class="btn btn-link btn-sm p-0 text-info" onclick="event.stopPropagation(); sendInput('${fullPath}')" title="Send path to terminal">
                            <i class="bi bi-terminal"></i>
                        </button>
                    </div>
                `;

                if (viewMode === 'list') {
                    item.innerHTML = `
                        ${checkboxHtml}
                        <span class="icon"><i class="${iconClass}"></i></span>
                        <span class="name" title="${file.name}">${file.name}</span>
                        <span class="size">${size}</span>
                        ${actionsHtml}
                    `;
                } else {
                    item.innerHTML = `
                        ${checkboxHtml}
                        ${actionsHtml}
                        <span class="icon"><i class="${iconClass}"></i></span>
                        <span class="name" title="${file.name}">${file.name}</span>
                    `;
                }
                
                item.onclick = () => {
                    if (file.is_dir) {
                        currentExplorerPath = (currentExplorerPath === '' ? '' : currentExplorerPath + '/') + file.name;
                        document.getElementById('current-path').innerText = currentExplorerPath;
                        document.getElementById('remotePath').value = currentExplorerPath + '/';
                        refreshFiles();
                    } else {
                        document.getElementById('remotePath').value = fullPath;
                    }
                };
                
                listContainer.appendChild(item);
            });
        }

        function toggleItemSelection(path) {
            if (selectedItems.has(path)) {
                selectedItems.delete(path);
            } else {
                selectedItems.add(path);
            }
            updateDeleteButton();
            renderFileList(cachedFiles);
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function sendInput(data) {
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(textEncoder.encode(data));
            }
        }

        function sendResize() {
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    type: 'resize',
                    cols: term.cols,
                    rows: term.rows
                }));
            }
        }

        term.onData(data => {
            sendInput(data);
        });

        function connect() {
            const host = document.getElementById('host').value;
            const port = parseInt(document.getElementById('port').value);
            const user = document.getElementById('user').value;
            const auth_type = document.getElementById('auth_type').value;
            const pass = document.getElementById('pass').value;
            const key = document.getElementById('key').value;
            updateDefaultRemotePath();

            if (socket) socket.close();

            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            socket = new WebSocket(`${protocol}//${window.location.host}/ws`);
            socket.binaryType = 'arraybuffer';

            socket.onopen = () => {
                socket.send(JSON.stringify({ host, port, user, auth_type, pass, key }));
                document.getElementById('login-form').classList.add('hidden');
                document.getElementById('upload-area').classList.remove('hidden');
                document.getElementById('file-explorer').classList.remove('hidden');
                document.getElementById('resizer').classList.remove('hidden');
                
                currentExplorerPath = `/home/${user}`;
                document.getElementById('current-path').innerText = currentExplorerPath;
                setViewMode('list');
                refreshFiles();

                term.focus();
                fitAddon.fit();
                sendResize();
            };

            socket.onmessage = (e) => {
                term.write(typeof e.data === 'string' ? e.data : new Uint8Array(e.data));
            };

            socket.onclose = () => {
                term.write('\r\nConnection closed\r\n');
                document.getElementById('login-form').classList.remove('hidden');
                document.getElementById('upload-area').classList.add('hidden');
                document.getElementById('file-explorer').classList.add('hidden');
                document.getElementById('resizer').classList.add('hidden');
            };
        }

        function setDropZoneText(text) {
            document.getElementById('drop-zone').innerText = text;
        }

        async function uploadFile(fileOverride = null) {
            const fileInput = document.getElementById('fileInput');
            const remotePath = document.getElementById('remotePath').value;
            const status = document.getElementById('upload-status');
            const autoInput = document.getElementById('autoInputPath').checked;
            const file = fileOverride || droppedFile || fileInput.files[0];

            if (!file || !remotePath) return alert("Select file and path");

            let finalPath = remotePath;
            if (finalPath.endsWith('/') || !finalPath.split('/').pop().includes('.')) {
                if (!finalPath.endsWith('/')) finalPath += '/';
                finalPath += file.name;
            }

            const formData = new FormData();
            formData.append('file', file);
            formData.append('path', finalPath);
            formData.append('host', document.getElementById('host').value);
            formData.append('port', document.getElementById('port').value);
            formData.append('user', document.getElementById('user').value);
            formData.append('auth_type', document.getElementById('auth_type').value);
            formData.append('pass', document.getElementById('pass').value);
            formData.append('key', document.getElementById('key').value);

            status.innerText = "Uploading...";
            isUploading = true;
            setDropZoneText('Uploading 0%');
            try {
                const result = await new Promise((resolve, reject) => {
                    const xhr = new XMLHttpRequest();
                    xhr.open('POST', '/upload');
                    xhr.upload.onprogress = (e) => {
                        if (!e.lengthComputable) return;
                        const percent = Math.round((e.loaded / e.total) * 100);
                        setDropZoneText(`Uploading ${percent}%`);
                    };
                    xhr.onload = () => {
                        if (xhr.status >= 200 && xhr.status < 300) {
                            resolve(xhr.responseText);
                        } else {
                            reject(new Error(xhr.responseText || `HTTP ${xhr.status}`));
                        }
                    };
                    xhr.onerror = () => reject(new Error('Network error'));
                    xhr.send(formData);
                });
                status.innerText = result;

                if (result === "Success" && autoInput) {
                    // 仅发送路径，不加换行符
                    sendInput(finalPath);
                }
                if (result === "Success") {
                    refreshFiles();
                }
                setDropZoneText(`Uploaded: ${file.name}`);
                setTimeout(() => setDropZoneText(dropZoneDefaultText), 1500);
            } catch (e) {
                status.innerText = "Error: " + e.message;
                setDropZoneText(`Upload failed: ${file.name}`);
                setTimeout(() => setDropZoneText(dropZoneDefaultText), 1800);
            } finally {
                isUploading = false;
            }
        }

        window.onresize = () => {
            if (terminalContainer.style.width && terminalContainer.style.width.includes('px')) {
                const container = document.getElementById('main-container');
                if (container) {
                    const totalWidth = container.offsetWidth;
                    const currentW = parseInt(terminalContainer.style.width);
                    if (currentW > totalWidth - 160) {
                        terminalContainer.style.width = (totalWidth - 160) + 'px';
                    }
                }
            }
            fitAddon.fit();
            sendResize();
        };

        function updateDefaultRemotePath() {
            const user = document.getElementById('user').value.trim();
            if (!user) return;
            const remotePath = document.getElementById('remotePath');
            if (!remotePathTouched || remotePath.value.trim() === '') {
                remotePath.value = `/home/${user}/Uploads`;
            }
        }

        document.getElementById('user').addEventListener('input', updateDefaultRemotePath);
        document.getElementById('remotePath').addEventListener('input', () => {
            remotePathTouched = true;
        });
        document.getElementById('fileInput').addEventListener('change', (e) => {
            droppedFile = null;
            const file = e.target.files && e.target.files[0];
            document.getElementById('selectedFileName').innerText = file ? file.name : '';
        });

        const dropZone = document.getElementById('drop-zone');
        dropZone.addEventListener('click', () => document.getElementById('fileInput').click());

        function setDropZoneText(text) {
            dropZone.innerHTML = `<i class="bi bi-cloud-upload"></i> ${text}`;
        }
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults);
        });
        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.add('drag-over'));
        });
        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.remove('drag-over'));
        });
        dropZone.addEventListener('drop', (e) => {
            const files = e.dataTransfer && e.dataTransfer.files;
            if (files && files.length > 0) {
                if (isUploading) return;
                droppedFile = files[0];
                document.getElementById('selectedFileName').innerText = droppedFile.name;
                updateDefaultRemotePath();
                uploadFile(droppedFile);
            }
        });

        fetch('/config').then(r => r.json()).then(data => {
            if (data.default_ssh_host) document.getElementById('host').value = data.default_ssh_host;
            if (data.default_ssh_port) document.getElementById('port').value = data.default_ssh_port;
        }).catch(e => console.error("Config load failed", e));
    </script>
</body>
</html>
