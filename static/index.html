<!DOCTYPE html>
<html>
<head>
    <title>GgySSH Bridge</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" />
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>
    <style>
        body { background: #1a1a1a; color: #fff; font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        #login-form { padding: 20px; background: #333; display: flex; gap: 10px; flex-wrap: wrap; align-items: flex-start; }
        #login-form .input-group { display: flex; flex-direction: column; gap: 5px; }
        #login-form input, #login-form select, #login-form textarea { padding: 8px; border-radius: 4px; border: 1px solid #555; background: #222; color: #fff; }
        #login-form button { padding: 8px 16px; border-radius: 4px; border: none; background: #007bff; color: #fff; cursor: pointer; align-self: flex-end; }
        #main-container { flex: 1; display: flex; overflow: hidden; position: relative; }
        #terminal-container { flex: 3; padding: 10px; overflow: hidden; min-width: 200px; }
        #resizer {
            width: 6px;
            cursor: col-resize;
            background: #444;
            transition: background 0.2s;
            z-index: 10;
        }
        #resizer:hover, #resizer.dragging {
            background: #007bff;
        }
        #file-explorer { flex: 1; background: #252525; border-left: 1px solid #444; display: flex; flex-direction: column; overflow: hidden; min-width: 150px; }
        #explorer-header { padding: 8px 12px; background: #333; border-bottom: 1px solid #444; display: flex; flex-direction: column; gap: 5px; }
        #current-path { font-size: 12px; color: #aaa; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        #explorer-list { flex: 1; overflow-y: auto; font-size: 13px; }
        
        /* List View */
        #explorer-list.list-view .file-item { padding: 4px 12px; display: flex; align-items: center; gap: 8px; cursor: pointer; border-bottom: 1px solid #2a2a2a; }
        #explorer-list.list-view .file-item:hover { background: #333; }
        #explorer-list.list-view .file-item .icon { width: 16px; text-align: center; font-size: 14px; }
        #explorer-list.list-view .file-item .name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        #explorer-list.list-view .file-item .size { color: #888; font-size: 11px; }
        #explorer-list.list-view .file-item .actions { display: none; gap: 5px; }
        #explorer-list.list-view .file-item:hover .actions { display: flex; }

        /* Grid View */
        #explorer-list.grid-view { display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; align-content: flex-start; }
        #explorer-list.grid-view .file-item { 
            width: 80px; height: 90px; display: flex; flex-direction: column; align-items: center; justify-content: center; 
            padding: 5px; cursor: pointer; border-radius: 4px; border: 1px solid transparent; text-align: center;
        }
        #explorer-list.grid-view .file-item:hover { background: #333; border-color: #444; }
        #explorer-list.grid-view .file-item .icon { font-size: 32px; margin-bottom: 5px; }
        #explorer-list.grid-view .file-item .name { font-size: 11px; width: 100%; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; line-height: 1.2; height: 2.4em; }
        #explorer-list.grid-view .file-item .size { display: none; }
        #explorer-list.grid-view .file-item .actions { position: absolute; top: 2px; right: 2px; display: none; background: rgba(0,0,0,0.7); border-radius: 3px; }
        #explorer-list.grid-view .file-item:hover .actions { display: block; }
        #explorer-list.grid-view .file-item { position: relative; }

        .action-btn { padding: 2px 5px; font-size: 10px; background: #444; border-radius: 3px; cursor: pointer; }
        .action-btn:hover { background: #555; }
        #upload-area { padding: 10px; background: #333; border-top: 1px solid #444; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        #drop-zone {
            min-width: 220px;
            padding: 8px 12px;
            border: 1px dashed #777;
            border-radius: 6px;
            color: #ddd;
            font-size: 12px;
            text-align: center;
            user-select: none;
        }
        #drop-zone.drag-over {
            border-color: #3da5ff;
            background: rgba(61, 165, 255, 0.12);
            color: #fff;
        }
        .hidden { display: none !important; }
        textarea { width: 300px; height: 100px; font-family: monospace; font-size: 10px; }
        label { font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 5px; }
    </style>
</head>
<body>
    <div id="login-form">
        <div class="input-group">
            <input id="host" placeholder="Host" value="localhost" />
            <input id="port" placeholder="Port" value="22" type="number" style="width: 80px;" />
        </div>
        <div class="input-group">
            <input id="user" placeholder="Username" />
            <select id="auth_type" onchange="toggleAuth()">
                <option value="password">Password</option>
                <option value="key">Private Key</option>
            </select>
        </div>
        <div id="password-input" class="input-group">
            <input id="pass" placeholder="Password" type="password" />
        </div>
        <div id="key-input" class="input-group hidden">
            <textarea id="key" placeholder="Paste Private Key (id_rsa) here..."></textarea>
        </div>
        <button onclick="connect()">Connect</button>
    </div>

    <div id="main-container">
        <div id="terminal-container"></div>
        <div id="resizer" class="hidden"></div>
        <div id="file-explorer" class="hidden">
            <div id="explorer-header">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <strong>File Explorer</strong>
                    <div style="display: flex; gap: 5px;">
                        <button onclick="setViewMode('list')" class="action-btn" id="btn-list-view">List</button>
                        <button onclick="setViewMode('grid')" class="action-btn" id="btn-grid-view">Grid</button>
                        <button onclick="refreshFiles()" class="action-btn">Refresh</button>
                    </div>
                </div>
                <div id="current-path">/</div>
            </div>
            <div id="explorer-list" class="list-view"></div>
        </div>
    </div>

    <div id="upload-area" class="hidden">
        <div id="drop-zone">Drag file here</div>
        <input type="file" id="fileInput" />
        <span id="selectedFileName"></span>
        <input type="text" id="remotePath" placeholder="Remote Path" />
        <label>
            <input type="checkbox" id="autoInputPath" checked /> Ëá™Âä®Âú®ÁªàÁ´ØËæìÂÖ•Ë∑ØÂæÑ
        </label>
        <button onclick="uploadFile()">Upload via SFTP</button>
        <span id="upload-status"></span>
    </div>

    <script>
        function toggleAuth() {
            const type = document.getElementById('auth_type').value;
            document.getElementById('password-input').classList.toggle('hidden', type === 'key');
            document.getElementById('key-input').classList.toggle('hidden', type === 'password');
        }

        const term = new Terminal({ 
            theme: { background: '#1a1a1a' }, 
            cursorBlink: true,
            fontFamily: 'Menlo, Monaco, "Courier New", monospace',
            fontSize: 14
        });
        const fitAddon = new FitAddon.FitAddon();
        term.loadAddon(fitAddon);
        term.open(document.getElementById('terminal-container'));
        fitAddon.fit();

        let socket;
        let remotePathTouched = false;
        let droppedFile = null;
        let isUploading = false;
        const dropZoneDefaultText = 'Drag file here';
        const textEncoder = new TextEncoder();

        // Resizer logic
        const resizer = document.getElementById('resizer');
        const terminalContainer = document.getElementById('terminal-container');
        const fileExplorer = document.getElementById('file-explorer');
        let isResizing = false;

        resizer.addEventListener('mousedown', (e) => {
            isResizing = true;
            resizer.classList.add('dragging');
            document.body.style.cursor = 'col-resize';
            e.preventDefault();
        });

        document.addEventListener('mousemove', (e) => {
            if (!isResizing) return;
            const containerWidth = document.getElementById('main-container').offsetWidth;
            const leftWidth = e.clientX;
            const rightWidth = containerWidth - leftWidth - resizer.offsetWidth;
            
            if (leftWidth > 200 && rightWidth > 150) {
                terminalContainer.style.flex = 'none';
                terminalContainer.style.width = `${leftWidth}px`;
                fileExplorer.style.flex = 'none';
                fileExplorer.style.width = `${rightWidth}px`;
                
                fitAddon.fit();
                sendResize();
            }
        });

        document.addEventListener('mouseup', () => {
            if (isResizing) {
                isResizing = false;
                resizer.classList.remove('dragging');
                document.body.style.cursor = 'default';
                fitAddon.fit();
                sendResize();
            }
        });

        let currentExplorerPath = '';
        let viewMode = 'list'; // 'list' or 'grid'
        let cachedFiles = [];

        function setViewMode(mode) {
            viewMode = mode;
            const listContainer = document.getElementById('explorer-list');
            listContainer.className = mode + '-view';
            
            // Highlight active button
            document.getElementById('btn-list-view').style.background = mode === 'list' ? '#007bff' : '#444';
            document.getElementById('btn-grid-view').style.background = mode === 'grid' ? '#007bff' : '#444';
            
            if (cachedFiles.length > 0) {
                renderFileList(cachedFiles);
            }
        }

        function getCreds() {
            return {
                host: document.getElementById('host').value,
                port: parseInt(document.getElementById('port').value),
                user: document.getElementById('user').value,
                auth_type: document.getElementById('auth_type').value,
                pass: document.getElementById('pass').value,
                key: document.getElementById('key').value
            };
        }

        async function refreshFiles() {
            const listContainer = document.getElementById('explorer-list');
            listContainer.innerHTML = '<div style="padding: 10px; color: #888;">Loading...</div>';
            
            try {
                const resp = await fetch('/sftp/list', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ...getCreds(),
                        path: currentExplorerPath || '.'
                    })
                });
                
                if (!resp.ok) throw new Error(await resp.text());
                
                cachedFiles = await resp.json();
                renderFileList(cachedFiles);
            } catch (e) {
                listContainer.innerHTML = `<div style="padding: 10px; color: #f44;">Error: ${e.message}</div>`;
            }
        }

        function renderFileList(files) {
            const listContainer = document.getElementById('explorer-list');
            listContainer.innerHTML = '';

            // Back button
            if (currentExplorerPath && currentExplorerPath !== '/' && currentExplorerPath !== '.') {
                const backItem = document.createElement('div');
                backItem.className = 'file-item';
                backItem.title = 'Go back';
                backItem.innerHTML = `<span class="icon">${viewMode === 'list' ? '‚§¥' : 'üîô'}</span> <span class="name">..</span>`;
                backItem.onclick = () => {
                    const parts = currentExplorerPath.split('/').filter(p => p);
                    parts.pop();
                    currentExplorerPath = '/' + parts.join('/');
                    if (currentExplorerPath === '/') currentExplorerPath = '';
                    document.getElementById('current-path').innerText = currentExplorerPath || '/';
                    refreshFiles();
                };
                listContainer.appendChild(backItem);
            }

            // Sort: directories first
            files.sort((a, b) => {
                if (a.is_dir !== b.is_dir) return b.is_dir ? 1 : -1;
                return a.name.localeCompare(b.name);
            });

            files.forEach(file => {
                const item = document.createElement('div');
                item.className = 'file-item';
                
                const icon = file.is_dir ? 'üìÅ' : 'üìÑ';
                const size = file.is_dir ? '' : formatBytes(file.size);
                
                if (viewMode === 'list') {
                    item.innerHTML = `
                        <span class="icon">${icon}</span>
                        <span class="name" title="${file.name}">${file.name}</span>
                        <span class="size">${size}</span>
                        <div class="actions">
                            <span class="action-btn" onclick="event.stopPropagation(); deleteFile('${file.name}')">Del</span>
                        </div>
                    `;
                } else {
                    item.innerHTML = `
                        <span class="icon">${icon}</span>
                        <span class="name" title="${file.name}">${file.name}</span>
                        <div class="actions">
                            <span class="action-btn" onclick="event.stopPropagation(); deleteFile('${file.name}')">Del</span>
                        </div>
                    `;
                }
                
                item.onclick = () => {
                    if (file.is_dir) {
                        currentExplorerPath = (currentExplorerPath === '' ? '' : currentExplorerPath + '/') + file.name;
                        document.getElementById('current-path').innerText = currentExplorerPath;
                        document.getElementById('remotePath').value = currentExplorerPath + '/';
                        refreshFiles();
                    } else {
                        // For files, maybe just set the upload path
                        document.getElementById('remotePath').value = (currentExplorerPath === '' ? '' : currentExplorerPath + '/') + file.name;
                    }
                };
                
                listContainer.appendChild(item);
            });
        }

        async function deleteFile(name) {
            if (!confirm(`Delete ${name}?`)) return;
            const fullPath = (currentExplorerPath === '' ? '' : currentExplorerPath + '/') + name;
            try {
                const resp = await fetch('/sftp/action', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ...getCreds(),
                        action: 'delete',
                        path: fullPath
                    })
                });
                if (!resp.ok) throw new Error(await resp.text());
                refreshFiles();
            } catch (e) {
                alert("Delete failed: " + e.message);
            }
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function sendInput(data) {
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(textEncoder.encode(data));
            }
        }

        function sendResize() {
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    type: 'resize',
                    cols: term.cols,
                    rows: term.rows
                }));
            }
        }

        term.onData(data => {
            sendInput(data);
        });

        function connect() {
            const host = document.getElementById('host').value;
            const port = parseInt(document.getElementById('port').value);
            const user = document.getElementById('user').value;
            const auth_type = document.getElementById('auth_type').value;
            const pass = document.getElementById('pass').value;
            const key = document.getElementById('key').value;
            updateDefaultRemotePath();

            if (socket) socket.close();

            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            socket = new WebSocket(`${protocol}//${window.location.host}/ws`);
            socket.binaryType = 'arraybuffer';

            socket.onopen = () => {
                socket.send(JSON.stringify({ host, port, user, auth_type, pass, key }));
                document.getElementById('login-form').classList.add('hidden');
                document.getElementById('upload-area').classList.remove('hidden');
                document.getElementById('file-explorer').classList.remove('hidden');
                document.getElementById('resizer').classList.remove('hidden');
                
                currentExplorerPath = `/home/${user}`;
                document.getElementById('current-path').innerText = currentExplorerPath;
                setViewMode('list');
                refreshFiles();

                term.focus();
                fitAddon.fit();
                sendResize();
            };

            socket.onmessage = (e) => {
                term.write(typeof e.data === 'string' ? e.data : new Uint8Array(e.data));
            };

            socket.onclose = () => {
                term.write('\r\nConnection closed\r\n');
                document.getElementById('login-form').classList.remove('hidden');
                document.getElementById('upload-area').classList.add('hidden');
                document.getElementById('file-explorer').classList.add('hidden');
                document.getElementById('resizer').classList.add('hidden');
            };
        }

        function setDropZoneText(text) {
            document.getElementById('drop-zone').innerText = text;
        }

        async function uploadFile(fileOverride = null) {
            const fileInput = document.getElementById('fileInput');
            const remotePath = document.getElementById('remotePath').value;
            const status = document.getElementById('upload-status');
            const autoInput = document.getElementById('autoInputPath').checked;
            const file = fileOverride || droppedFile || fileInput.files[0];

            if (!file || !remotePath) return alert("Select file and path");

            let finalPath = remotePath;
            if (finalPath.endsWith('/') || !finalPath.split('/').pop().includes('.')) {
                if (!finalPath.endsWith('/')) finalPath += '/';
                finalPath += file.name;
            }

            const formData = new FormData();
            formData.append('file', file);
            formData.append('path', finalPath);
            formData.append('host', document.getElementById('host').value);
            formData.append('port', document.getElementById('port').value);
            formData.append('user', document.getElementById('user').value);
            formData.append('auth_type', document.getElementById('auth_type').value);
            formData.append('pass', document.getElementById('pass').value);
            formData.append('key', document.getElementById('key').value);

            status.innerText = "Uploading...";
            isUploading = true;
            setDropZoneText('Uploading 0%');
            try {
                const result = await new Promise((resolve, reject) => {
                    const xhr = new XMLHttpRequest();
                    xhr.open('POST', '/upload');
                    xhr.upload.onprogress = (e) => {
                        if (!e.lengthComputable) return;
                        const percent = Math.round((e.loaded / e.total) * 100);
                        setDropZoneText(`Uploading ${percent}%`);
                    };
                    xhr.onload = () => {
                        if (xhr.status >= 200 && xhr.status < 300) {
                            resolve(xhr.responseText);
                        } else {
                            reject(new Error(xhr.responseText || `HTTP ${xhr.status}`));
                        }
                    };
                    xhr.onerror = () => reject(new Error('Network error'));
                    xhr.send(formData);
                });
                status.innerText = result;

                if (result === "Success" && autoInput) {
                    // ‰ªÖÂèëÈÄÅË∑ØÂæÑÔºå‰∏çÂä†Êç¢Ë°åÁ¨¶
                    sendInput(finalPath);
                }
                if (result === "Success") {
                    refreshFiles();
                }
                setDropZoneText(`Uploaded: ${file.name}`);
                setTimeout(() => setDropZoneText(dropZoneDefaultText), 1500);
            } catch (e) {
                status.innerText = "Error: " + e.message;
                setDropZoneText(`Upload failed: ${file.name}`);
                setTimeout(() => setDropZoneText(dropZoneDefaultText), 1800);
            } finally {
                isUploading = false;
            }
        }

        window.onresize = () => {
            fitAddon.fit();
            sendResize();
        };

        function updateDefaultRemotePath() {
            const user = document.getElementById('user').value.trim();
            if (!user) return;
            const remotePath = document.getElementById('remotePath');
            if (!remotePathTouched || remotePath.value.trim() === '') {
                remotePath.value = `/home/${user}/Uploads`;
            }
        }

        document.getElementById('user').addEventListener('input', updateDefaultRemotePath);
        document.getElementById('remotePath').addEventListener('input', () => {
            remotePathTouched = true;
        });
        document.getElementById('fileInput').addEventListener('change', (e) => {
            droppedFile = null;
            const file = e.target.files && e.target.files[0];
            document.getElementById('selectedFileName').innerText = file ? file.name : '';
        });

        const dropZone = document.getElementById('drop-zone');
        setDropZoneText(dropZoneDefaultText);
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults);
        });
        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.add('drag-over'));
        });
        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.remove('drag-over'));
        });
        dropZone.addEventListener('drop', (e) => {
            const files = e.dataTransfer && e.dataTransfer.files;
            if (files && files.length > 0) {
                if (isUploading) return;
                droppedFile = files[0];
                document.getElementById('selectedFileName').innerText = droppedFile.name;
                updateDefaultRemotePath();
                uploadFile(droppedFile);
            }
        });

        fetch('/config').then(r => r.json()).then(data => {
            if (data.default_ssh_host) document.getElementById('host').value = data.default_ssh_host;
            if (data.default_ssh_port) document.getElementById('port').value = data.default_ssh_port;
        }).catch(e => console.error("Config load failed", e));
    </script>
</body>
</html>
